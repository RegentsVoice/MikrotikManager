{% extends "base.html" %}

{% block title %}Системная информация - {{ device.name }} - MikroTik Manager{% endblock %}

{% block head_extra %}
<style>
/* Стили для страницы системной информации */
.sysinfo-alert {
    background-color: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-left: 4px solid var(--primary-color);
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 6px;
}

.sysinfo-alert .alert-icon {
    font-size: 1.5rem;
    margin-right: 10px;
    opacity: 0.9;
}

/* Улучшенные табы для системной информации */
.sysinfo-tabs .nav-tabs {
    border-bottom: 2px solid var(--border-color);
    margin-bottom: 0;
}

.sysinfo-tabs .nav-link {
    color: var(--text-secondary);
    background-color: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-bottom: none;
    margin-bottom: -1px;
    padding: 12px 20px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.sysinfo-tabs .nav-link:hover {
    color: var(--text-primary);
    background-color: var(--hover-color);
}

.sysinfo-tabs .nav-link.active {
    background-color: var(--bg-secondary);
    border-color: var(--border-color) var(--border-color) var(--bg-secondary);
    color: var(--text-primary);
    font-weight: 600;
}

.sysinfo-tabs .nav-link i {
    margin-right: 8px;
    font-size: 1.1em;
}

/* Контент табов */
.sysinfo-tab-content {
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-top: none;
    padding: 25px;
    border-radius: 0 0 8px 8px;
}

/* Карточки внутри табов */
.sysinfo-card {
    background-color: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.sysinfo-card-header {
    background-color: rgba(0, 0, 0, 0.05);
    border-bottom: 1px solid var(--border-color);
    padding: 15px 20px;
    font-weight: 600;
    color: var(--text-primary);
}

[data-theme="dark"] .sysinfo-card-header {
    background-color: rgba(0, 0, 0, 0.15);
}

.sysinfo-card-body {
    padding: 20px;
}

/* Таблицы системной информации */
.sysinfo-table {
    background-color: transparent;
    width: 100%;
    color: var(--text-primary);
}

.sysinfo-table th {
    background-color: var(--bg-tertiary);
    color: var(--text-primary);
    border-bottom: 2px solid var(--border-color);
    font-weight: 600;
    padding: 12px;
    width: 40%;
    text-transform: uppercase;
    font-size: 0.85em;
    letter-spacing: 0.5px;
}

.sysinfo-table td {
    color: var(--text-secondary);
    border-top: 1px solid var(--border-color);
    padding: 12px;
    vertical-align: middle;
    font-weight: 500;
}

.sysinfo-table tr:hover td {
    background-color: var(--hover-color);
    color: var(--text-primary);
}

/* Кодовые блоки */
.code-block {
    background-color: var(--code-bg);
    border: 1px solid var(--code-border);
    color: var(--code-text);
    padding: 3px 8px;
    border-radius: 4px;
    font-family: 'SF Mono', 'Consolas', 'Monaco', 'Liberation Mono', monospace;
    font-size: 0.9em;
    font-weight: 500;
}

/* Специальные таблицы с данными */
.data-table-container {
    border-radius: 8px;
    border: 1px solid var(--border-color);
    background-color: var(--bg-tertiary);
    overflow: hidden;
}

.data-table {
    width: 100%;
    margin-bottom: 0;
    color: var(--text-primary);
}

.data-table thead th {
    background-color: var(--bg-tertiary);
    border-bottom: 2px solid var(--border-color);
    padding: 12px;
    font-weight: 600;
    color: var(--text-primary);
    position: sticky;
    top: 0;
    z-index: 10;
}

.data-table tbody td {
    padding: 12px;
    border-top: 1px solid var(--border-color);
    color: var(--text-secondary);
}

.data-table tbody tr:hover {
    background-color: var(--hover-color);
}

.data-table tbody tr:hover td {
    color: var(--text-primary);
}

/* Прогресс-бары */
.sysinfo-progress {
    background-color: var(--bg-tertiary);
    height: 22px;
    border-radius: 11px;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.sysinfo-progress-bar {
    background-color: var(--primary-color);
    transition: width 0.6s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.85rem;
    font-weight: 600;
    text-shadow: 0 1px 1px rgba(0,0,0,0.3);
}

/* Бейджи для статусов */
.sysinfo-badge {
    font-weight: 600;
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 0.85em;
}

/* Адаптивность */
@media (max-width: 768px) {
    .sysinfo-tabs .nav-link {
        padding: 10px 15px;
        font-size: 0.9rem;
    }
    
    .sysinfo-tab-content {
        padding: 15px;
    }
    
    .sysinfo-table th,
    .sysinfo-table td {
        padding: 10px 8px;
        font-size: 0.9rem;
    }
    
    .sysinfo-card-header {
        padding: 12px 15px;
    }
    
    .sysinfo-card-body {
        padding: 15px;
    }
}

@media (max-width: 576px) {
    .sysinfo-tabs .nav-link {
        padding: 8px 12px;
        font-size: 0.85rem;
    }
    
    .sysinfo-tab-content {
        padding: 12px;
    }
    
    .sysinfo-table th,
    .sysinfo-table td {
        padding: 8px 6px;
        font-size: 0.85rem;
    }
    
    .sysinfo-card {
        margin-bottom: 15px;
    }
}

/* Цвета для статусов температуры */
.temp-low { color: #28a745; }
.temp-medium { color: #ffc107; }
.temp-high { color: #dc3545; }

/* Индикаторы CPU */
.cpu-low { color: #28a745; }
.cpu-medium { color: #ffc107; }
.cpu-high { color: #dc3545; }

/* Статусы интерфейсов */
.interface-up { color: #28a745; }
.interface-down { color: #dc3545; }
.interface-disabled { color: #6c757d; }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0">Системная информация: {{ device.name }}</h4>
                    <small class="text-muted">{{ device.ip_address }}:{{ device.port }}</small>
                </div>
                <span class="badge bg-success fs-6">
                    <i class="fas fa-wifi me-1"></i>Online
                </span>
            </div>
            
            <div class="card-body">
                <!-- Статус устройства -->
                <div class="sysinfo-alert mb-4">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle alert-icon text-success"></i>
                        <div>
                            <strong>Устройство онлайн</strong>
                            <div class="small mt-1">
                                <span class="me-3"><i class="fas fa-clock me-1 text-muted"></i>Время устройства: {{ info.basic.current_time }}</span>
                                <span><i class="fas fa-hourglass-half me-1 text-muted"></i>Uptime: {{ info.basic.uptime }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Табы -->
                <div class="sysinfo-tabs">
                    <nav>
                        <div class="nav nav-tabs" id="sysinfoTab" role="tablist">
                            <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button">
                                <i class="fas fa-info-circle me-2"></i>Основное
                            </button>
                            <button class="nav-link" id="hardware-tab" data-bs-toggle="tab" data-bs-target="#hardware" type="button">
                                <i class="fas fa-microchip me-2"></i>Оборудование
                            </button>
                            <button class="nav-link" id="resources-tab" data-bs-toggle="tab" data-bs-target="#resources" type="button">
                                <i class="fas fa-chart-bar me-2"></i>Ресурсы
                            </button>
                            <button class="nav-link" id="network-tab" data-bs-toggle="tab" data-bs-target="#network" type="button">
                                <i class="fas fa-network-wired me-2"></i>Сеть
                            </button>
                            <button class="nav-link" id="packages-tab" data-bs-toggle="tab" data-bs-target="#packages" type="button">
                                <i class="fas fa-box-open me-2"></i>Пакеты
                            </button>
                        </div>
                    </nav>
                    
                    <div class="sysinfo-tab-content">
                        <div class="tab-content" id="sysinfoTabContent">
                            <!-- Вкладка Основное -->
                            <div class="tab-pane fade show active" id="basic" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="sysinfo-card mb-3">
                                            <div class="sysinfo-card-header">
                                                <h6 class="mb-0">Информация о системе</h6>
                                            </div>
                                            <div class="sysinfo-card-body">
                                                <table class="sysinfo-table">
                                                    <tr>
                                                        <th>Имя в системе:</th>
                                                        <td><span class="code-block">{{ info.basic.identity }}</span></td>
                                                    </tr>
                                                    <tr>
                                                        <th>RouterOS версия:</th>
                                                        <td><span class="sysinfo-badge bg-info">{{ info.basic.version }}</span></td>
                                                    </tr>
                                                    <tr>
                                                        <th>Архитектура:</th>
                                                        <td>{{ info.basic.architecture }}</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Уровень лицензии:</th>
                                                        <td><span class="sysinfo-badge bg-warning">{{ info.license.level }}</span></td>
                                                    </tr>
                                                    <tr>
                                                        <th>Время работы:</th>
                                                        <td>{{ info.basic.uptime }}</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Текущее время:</th>
                                                        <td>{{ info.basic.current_time }}</td>
                                                    </tr>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="sysinfo-card mb-3">
                                            <div class="sysinfo-card-header">
                                                <h6 class="mb-0">Действия</h6>
                                            </div>
                                            <div class="sysinfo-card-body">
                                                <div class="d-grid gap-2">
                                                    <a href="{{ url_for('check_device_update', device_id=device.id) }}" 
                                                       class="btn btn-primary">
                                                        <i class="fas fa-sync-alt me-2"></i>Проверить обновления
                                                    </a>
                                                    <a href="{{ url_for('get_device_system_info', device_id=device.id) }}" 
                                                       class="btn btn-outline-primary">
                                                        <i class="fas fa-redo me-2"></i>Обновить информацию
                                                    </a>
                                                    <a href="{{ url_for('device_backups', device_id=device.id) }}" 
                                                       class="btn btn-outline-warning">
                                                        <i class="fas fa-save me-2"></i>Резервные копии
                                                    </a>
                                                    <a href="{{ url_for('debug_device_connection', device_id=device.id) }}" 
                                                       class="btn btn-outline-secondary">
                                                        <i class="fas fa-bug me-2"></i>Отладка подключения
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Вкладка Оборудование -->
                            <div class="tab-pane fade" id="hardware" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="sysinfo-card">
                                            <div class="sysinfo-card-header">
                                                <h6 class="mb-0">Информация о RouterBoard</h6>
                                            </div>
                                            <div class="sysinfo-card-body">
                                                <table class="sysinfo-table">
                                                    <tr>
                                                        <th>Модель:</th>
                                                        <td><strong>{{ info.hardware.board_name }}</strong></td>
                                                    </tr>
                                                    <tr>
                                                        <th>Серийный номер:</th>
                                                        <td><span class="code-block">{{ info.hardware.serial_number }}</span></td>
                                                    </tr>
                                                    <tr>
                                                        <th>Тип прошивки:</th>
                                                        <td>{{ info.hardware.firmware_type }}</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Версия прошивки:</th>
                                                        <td>{{ info.hardware.board_version }}</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Температура:</th>
                                                        <td>
                                                            {% if info.hardware.temperature != 'N/A' %}
                                                                {% set temp = info.hardware.temperature|replace('°C', '')|float %}
                                                                {% if temp < 50 %}
                                                                    <span class="temp-low"><i class="fas fa-thermometer-empty me-1"></i>{{ info.hardware.temperature }}</span>
                                                                {% elif temp < 70 %}
                                                                    <span class="temp-medium"><i class="fas fa-thermometer-half me-1"></i>{{ info.hardware.temperature }}</span>
                                                                {% else %}
                                                                    <span class="temp-high"><i class="fas fa-thermometer-full me-1"></i>{{ info.hardware.temperature }}</span>
                                                                {% endif %}
                                                            {% else %}
                                                                <span class="text-muted">{{ info.hardware.temperature }}</span>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <th>Хранилище:</th>
                                                        <td>{{ info.hardware.storage }}</td>
                                                    </tr>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Вкладка Ресурсы -->
                            <div class="tab-pane fade" id="resources" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="sysinfo-card mb-3">
                                            <div class="sysinfo-card-header">
                                                <h6 class="mb-0">Использование памяти</h6>
                                            </div>
                                            <div class="sysinfo-card-body">
                                                <div class="mb-3">
                                                    <div class="d-flex justify-content-between mb-2">
                                                        <span class="text-muted">Оперативная память</span>
                                                        <span class="text-muted">{{ info.resources.free_memory }} свободно / {{ info.resources.total_memory }} всего</span>
                                                    </div>
                                                    {% set mem_parts = info.resources.free_memory.split(' ') %}
                                                    {% set total_parts = info.resources.total_memory.split(' ') %}
                                                    {% if mem_parts|length == 2 and total_parts|length == 2 %}
                                                        {% set free_val = mem_parts[0]|float %}
                                                        {% set total_val = total_parts[0]|float %}
                                                        {% set used_val = total_val - free_val %}
                                                        {% set usage_percent = (used_val / total_val * 100)|round(1) %}
                                                        <div class="sysinfo-progress">
                                                            <div class="sysinfo-progress-bar" role="progressbar" 
                                                                 style="width: {{ usage_percent }}%;" 
                                                                 aria-valuenow="{{ usage_percent }}" 
                                                                 aria-valuemin="0" 
                                                                 aria-valuemax="100">
                                                                {{ usage_percent }}%
                                                            </div>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="sysinfo-card mb-3">
                                            <div class="sysinfo-card-header">
                                                <h6 class="mb-0">Процессор</h6>
                                            </div>
                                            <div class="sysinfo-card-body">
                                                <table class="sysinfo-table">
                                                    <tr>
                                                        <th>Загрузка CPU:</th>
                                                        <td>
                                                            {% set cpu_load_val = info.resources.cpu_load|replace('%', '')|int %}
                                                            {% if cpu_load_val < 50 %}
                                                                <span class="cpu-low"><i class="fas fa-microchip me-1"></i>{{ info.resources.cpu_load }}</span>
                                                            {% elif cpu_load_val < 80 %}
                                                                <span class="cpu-medium"><i class="fas fa-microchip me-1"></i>{{ info.resources.cpu_load }}</span>
                                                            {% else %}
                                                                <span class="cpu-high"><i class="fas fa-microchip me-1"></i>{{ info.resources.cpu_load }}</span>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <th>Количество ядер:</th>
                                                        <td>{{ info.resources.cpu_count }}</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Частота CPU:</th>
                                                        <td>{{ info.resources.cpu_frequency }}</td>
                                                    </tr>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Вкладка Сеть -->
                            <div class="tab-pane fade" id="network" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="sysinfo-card mb-3">
                                            <div class="sysinfo-card-header d-flex justify-content-between align-items-center">
                                                <h6 class="mb-0">Сетевые интерфейсы</h6>
                                                <span class="badge bg-primary">{{ info.interfaces|length }}</span>
                                            </div>
                                            <div class="sysinfo-card-body p-0">
                                                <div class="data-table-container">
                                                    <table class="data-table">
                                                        <thead>
                                                            <tr>
                                                                <th>Имя</th>
                                                                <th>Тип</th>
                                                                <th>MAC</th>
                                                                <th>Статус</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for iface in info.interfaces %}
                                                            <tr>
                                                                <td><span class="code-block">{{ iface.name }}</span></td>
                                                                <td><small>{{ iface.type }}</small></td>
                                                                <td><small>{{ iface.get('mac-address', 'N/A') }}</small></td>
                                                                <td>
                                                                    {% if iface.running == 'true' %}
                                                                        <span class="interface-up"><i class="fas fa-circle me-1"></i>Up</span>
                                                                    {% else %}
                                                                        <span class="interface-down"><i class="fas fa-circle me-1"></i>Down</span>
                                                                    {% endif %}
                                                                    {% if iface.disabled == 'true' %}
                                                                        <span class="interface-disabled ms-1"><i class="fas fa-ban me-1"></i>Disabled</span>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="sysinfo-card mb-3">
                                            <div class="sysinfo-card-header d-flex justify-content-between align-items-center">
                                                <h6 class="mb-0">IP адреса</h6>
                                                <span class="badge bg-primary">{{ info.ip_addresses|length }}</span>
                                            </div>
                                            <div class="sysinfo-card-body p-0">
                                                <div class="data-table-container">
                                                    <table class="data-table">
                                                        <thead>
                                                            <tr>
                                                                <th>IP адрес</th>
                                                                <th>Интерфейс</th>
                                                                <th>Сеть</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for ip in info.ip_addresses %}
                                                            <tr>
                                                                <td><span class="code-block">{{ ip.address }}</span></td>
                                                                <td><small>{{ ip.interface }}</small></td>
                                                                <td><small>{{ ip.get('network', 'N/A') }}</small></td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Вкладка Пакеты -->
                            <div class="tab-pane fade" id="packages" role="tabpanel">
                                <div class="sysinfo-card">
                                    <div class="sysinfo-card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">Установленные пакеты</h6>
                                        <span class="badge bg-primary">{{ info.packages|length }}</span>
                                    </div>
                                    <div class="sysinfo-card-body p-0">
                                        <div class="data-table-container">
                                            <table class="data-table">
                                                <thead>
                                                    <tr>
                                                        <th>Имя пакета</th>
                                                        <th>Версия</th>
                                                        <th>Статус</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for pkg in info.packages %}
                                                    <tr>
                                                        <td>
                                                            {% if pkg.name == 'routeros' %}
                                                                <i class="fas fa-cube text-primary me-2"></i>
                                                            {% elif pkg.name == 'routeros-mipsbe' %}
                                                                <i class="fas fa-microchip text-success me-2"></i>
                                                            {% elif pkg.name == 'wireless' %}
                                                                <i class="fas fa-wifi text-info me-2"></i>
                                                            {% elif pkg.name == 'security' %}
                                                                <i class="fas fa-shield-alt text-warning me-2"></i>
                                                            {% else %}
                                                                <i class="fas fa-box text-secondary me-2"></i>
                                                            {% endif %}
                                                            {{ pkg.name }}
                                                        </td>
                                                        <td><span class="code-block">{{ pkg.version }}</span></td>
                                                        <td>
                                                            <span class="sysinfo-badge bg-success">
                                                                <i class="fas fa-check me-1"></i>Установлен
                                                            </span>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Кнопки действий -->
                <div class="mt-4 pt-3 border-top">
                    <div class="d-flex justify-content-between align-items-center">
                        <a href="{{ url_for('devices') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Назад к устройствам
                        </a>
                        <div class="btn-group">
                            <a href="{{ url_for('check_device_update', device_id=device.id) }}" 
                               class="btn btn-outline-primary">
                                <i class="fas fa-sync-alt me-2"></i>Обновить
                            </a>
                            <a href="{{ url_for('edit_device', device_id=device.id) }}" 
                               class="btn btn-outline-warning">
                                <i class="fas fa-edit me-2"></i>Редактировать
                            </a>
                            <button onclick="printPage()" class="btn btn-outline-info">
                                <i class="fas fa-print me-2"></i>Печать
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function printPage() {
    window.print();
}

// Активация табов
document.addEventListener('DOMContentLoaded', function() {
    // Переключение табов по хэшу в URL
    const hash = window.location.hash;
    if (hash) {
        const tab = document.querySelector(`[data-bs-target="${hash}"]`);
        if (tab) {
            new bootstrap.Tab(tab).show();
        }
    }
});
</script>
{% endblock %}