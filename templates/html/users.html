{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-users me-2"></i>Управление пользователями</h2>
        <a href="{{ url_for('add_user') }}" class="btn btn-primary">
            <i class="fas fa-user-plus me-2"></i>Добавить пользователя
        </a>
    </div>
    
    <!-- Статистика -->
    <div class="row mb-4">
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h6 class="card-title">Всего пользователей</h6>
                    <h2 class="mb-0">{{ stats.total_users }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h6 class="card-title">Администраторов</h6>
                    <h2 class="mb-0">{{ stats.admins_count }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h6 class="card-title">Менеджеров</h6>
                    <h2 class="mb-0">{{ stats.managers_count }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card bg-{{ 'warning' if stats.inactive_users > 0 else 'secondary' }} text-white">
                <div class="card-body">
                    <h6 class="card-title">Неактивных</h6>
                    <h2 class="mb-0">{{ stats.inactive_users }}</h2>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Таблица пользователей -->
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Список пользователей</h5>
                <div class="input-group" style="width: 300px;">
                    <input type="text" id="userSearch" class="form-control" placeholder="Поиск пользователя...">
                    <button class="btn btn-outline-secondary" type="button">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="usersTable">
                    <thead>
                        <tr>
                            <th>Пользователь</th>
                            <th>Роль</th>
                            <th>Контакт</th>
                            <th>Статус</th>
                            <th>Дата регистрации</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar-circle-sm me-3">
                                        <span class="avatar-text-sm">{{ user.username[0]|upper }}</span>
                                    </div>
                                    <div>
                                        <strong>{{ user.full_name or user.username }}</strong>
                                        <div class="text-muted small">@{{ user.username }}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-{{ 'danger' if user.role == 'admin' else 'primary' }}">
                                    {{ 'Администратор' if user.role == 'admin' else 'Менеджер' }}
                                </span>
                            </td>
                            <td>
                                <div>
                                    {% if user.email %}
                                    <div class="small">
                                        <i class="fas fa-envelope me-1"></i>
                                        {{ user.email|truncate(20) }}
                                    </div>
                                    {% endif %}
                                    {% if user.phone %}
                                    <div class="small">
                                        <i class="fas fa-phone me-1"></i>
                                        {{ user.phone }}
                                    </div>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-{{ 'success' if user.is_active else 'danger' }}">
                                    {{ 'Активен' if user.is_active else 'Неактивен' }}
                                </span>
                                {% if user.last_login %}
                                <div class="small text-muted mt-1">
                                    Последний вход: {{ user.last_login.strftime('%d.%m.%Y') }}
                                </div>
                                {% endif %}
                            </td>
                            <td>
                                <div class="small">
                                    {{ user.created_at.strftime('%d.%m.%Y') }}
                                </div>
                                {% if user.creator %}
                                <div class="text-muted" style="font-size: 0.8rem;">
                                    Создал: {{ user.creator.username }}
                                </div>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    {% if current_user.id == user.id or current_user.role == 'admin' %}
                                    <a href="{{ url_for('edit_user', user_id=user.id) }}" 
                                       class="btn btn-outline-primary" title="Редактировать">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    {% endif %}
                                    
                                    {% if current_user.role == 'admin' and current_user.id != user.id %}
                                    <button class="btn btn-outline-{{ 'warning' if user.is_active else 'success' }}" 
                                            onclick="toggleUserStatus({{ user.id }}, {{ user.is_active|lower }})"
                                            title="{{ 'Деактивировать' if user.is_active else 'Активировать' }}">
                                        <i class="fas fa-toggle-{{ 'on' if user.is_active else 'off' }}"></i>
                                    </button>
                                    {% endif %}
                                    
                                    {% if current_user.role == 'admin' and current_user.id != user.id %}
                                    <button class="btn btn-outline-danger" 
                                            onclick="deleteUser({{ user.id }})"
                                            title="Удалить">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    .avatar-circle-sm {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(45deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 16px;
        font-weight: bold;
    }
    
    .avatar-text-sm {
        text-transform: uppercase;
    }
</style>

<script>
function toggleUserStatus(userId, isActive) {
    const action = isActive ? 'deactivate' : 'activate';
    const message = isActive ? 'Деактивировать пользователя?' : 'Активировать пользователя?';
    
    if (confirm(message)) {
        fetch(`/users/${userId}/${action}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Пользователь ${isActive ? 'деактивирован' : 'активирован'}!`);
                location.reload();
            } else {
                alert('Ошибка: ' + data.error);
            }
        })
        .catch(error => {
            alert('Ошибка сети: ' + error);
        });
    }
}

function deleteUser(userId) {
    if (confirm('Удалить пользователя? Все связанные данные будут переданы администратору.')) {
        fetch(`/users/${userId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Пользователь удален!');
                location.reload();
            } else {
                alert('Ошибка: ' + data.error);
            }
        })
        .catch(error => {
            alert('Ошибка сети: ' + error);
        });
    }
}

document.getElementById('userSearch').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('#usersTable tbody tr');
    
    rows.forEach(row => {
        const username = row.cells[0].textContent.toLowerCase();
        const email = row.cells[2].textContent.toLowerCase();
        const role = row.cells[1].textContent.toLowerCase();
        
        if (username.includes(searchTerm) || 
            email.includes(searchTerm) || 
            role.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});
</script>
{% endblock %}