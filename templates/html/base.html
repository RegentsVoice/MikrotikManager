<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <style id="critical-theme-css">
		body {
			background-color: #1a1a1a !important;
			color: #ffffff !important;
			opacity: 0;
			transition: opacity 0.2s ease !important;
		}
		
		/* Светлая тема - переопределится позже */
		html[data-theme="light"] body {
			background-color: #f8f9fa !important;
			color: #212529 !important;
		}
	</style>
    
    <title>{% block title %}MikroTik  Manager{% endblock %}</title>
	<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>☕</text></svg>">

	<script>
		(function() {
			try {
				const savedTheme = localStorage.getItem('theme');
				
				const prefersDark = window.matchMedia && 
					window.matchMedia('(prefers-color-scheme: dark)').matches;
				
				const theme = savedTheme || (prefersDark ? 'dark' : 'light');
				
				document.documentElement.setAttribute('data-theme', theme);
				
				requestAnimationFrame(() => {
					requestAnimationFrame(() => {
						document.documentElement.classList.add('theme-loaded');
						document.body.style.opacity = '1';
					});
				});
				
			} catch(e) {
				document.documentElement.setAttribute('data-theme', 'dark');
				document.documentElement.classList.add('theme-loaded');
				document.body.style.opacity = '1';
			}
		})();
	</script>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    {% block head_extra %}{% endblock %}
</head>
<body>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Навигация -->
    {% if current_user.is_authenticated %}
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('dashboard') }}">
                <i class="fas fa-server"></i>
                MikroTik Manager
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'dashboard' %}active{% endif %}" 
                           href="{{ url_for('dashboard') }}">
                            <i class="bi bi-speedometer2"></i> Дашборд
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'devices' %}active{% endif %}" 
                           href="{{ url_for('devices') }}">
                            <i class="bi bi-hdd-stack"></i> Устройства
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-tasks me-1"></i>Массовые операции
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('batch_check') }}">
                                <i class="fas fa-sync-alt me-1"></i>Массовая проверка
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('batch_update') }}">
                                <i class="fas fa-download me-1"></i>Массовое обновление
                            </a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'tasks' %}active{% endif %}" 
                           href="{{ url_for('tasks') }}">
                            <i class="bi bi-clock"></i> Задачи
                        </a>
                    </li>
					                    <!-- Меню пользователей (только для админов) -->
                    {% if current_user.role == 'admin' or current_user.is_admin %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'users' %}active{% endif %}" 
                           href="{{ url_for('users') }}">
                            <i class="fas fa-users me-1"></i> Пользователи
                        </a>
                    </li>
                    {% endif %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'logs' %}active{% endif %}" 
                           href="{{ url_for('logs') }}">
                            <i class="bi bi-journal-text"></i> Логи
                        </a>
                    </li>
                </ul>
                
                <ul class="navbar-nav">
                    <!-- Кнопка переключения темы -->
                    <li class="nav-item">
                        <button id="theme-toggle" class="btn btn-outline-light btn-sm me-2">
                            <i class="bi bi-moon"></i>
                        </button>
                    </li>
                    
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i>
                            {{ current_user.username }}
                            {% if current_user.role == 'admin' %}
                            <span class="badge bg-danger ms-1">Admin</span>
                            {% endif %}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <span class="dropdown-item-text">
                                    <small>Роль: {% if current_user.role == 'admin' %}Администратор{% else %}Менеджер{% endif %}</small>
                                </span>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('profile') }}">
                                    <i class="bi bi-person"></i> Мой профиль
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('logout') }}">
                                    <i class="bi bi-box-arrow-right"></i> Выйти
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    {% endif %}

    <div class="container-fluid mt-3">
        {% block content %}{% endblock %}
    </div>

<footer class="footer py-3 border-top">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-6 mb-2 mb-md-0">
                <p class="mb-1 footer-text">
                    <i class="fas fa-server me-1"></i>
                    <strong>MikroTik Update Manager</strong> 
                    <i class="fas fa-copyright ms-1"></i> 2025
                </p>
                <p class="footer-text-small mb-0">
                    <i class="fas fa-user me-1"></i>
                    Regent'sVoice &nbsp
                    <i class="fab fa-github me-1"></i>
                    <a href="https://github.com/RegentsVoice/Mikrotik-update-manager" 
                       target="_blank" rel="noopener" class="footer-link">
                        GitHub
                    </a>
                </p>
            </div>
            <div class="col-md-6 text-md-end">
                <p class="footer-text-small mb-1">
                    <i class="fab fa-bootstrap me-1"></i>
                    CSS: 
                    <a href="https://getbootstrap.com/" 
                       target="_blank" rel="noopener" class="footer-link">
                        Bootstrap 5
                    </a>
                </p>
                <p class="footer-text-small mb-0">
                    <i class="fab fa-font-awesome me-1"></i>
                    Fonts: 
                    <a href="https://fontawesome.com/" 
                       target="_blank" rel="noopener" class="footer-link">
                        Font Awesome 6
                    </a>
                </p>
            </div>
        </div>
    </div>
</footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = themeToggle?.querySelector('i');
        
        if (!themeToggle || !themeIcon) return;
        let currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
        
        updateThemeIcon(currentTheme);
        
        themeToggle.addEventListener('click', function() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            document.documentElement.setAttribute('data-theme', currentTheme);
            
            localStorage.setItem('theme', currentTheme);
            
            updateThemeIcon(currentTheme);
            
            setTimeout(() => {
                fetch('{{ url_for("toggle_theme") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                }).catch(() => {});
            }, 0);
        });
        
        function updateThemeIcon(theme) {
            if (theme === 'dark') {
                themeIcon.className = 'bi bi-sun';
            } else {
                themeIcon.className = 'bi bi-moon';
            }
        }
        
        if (!document.documentElement.classList.contains('theme-loaded')) {
            document.documentElement.classList.add('theme-loaded');
        }
    });
    
    function confirmAction(message) {
        return confirm(message || 'Вы уверены?');
    }
</script>
    
    {% block scripts %}{% endblock %}
</body>
</html>