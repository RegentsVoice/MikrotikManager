{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-4 col-md-5">
            <!-- Карточка профиля -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-user-circle me-2"></i>Мой профиль</h5>
                </div>
                <div class="card-body text-center">
                    <div class="mb-3">
                        <div class="avatar-circle mx-auto mb-3">
                            <span class="avatar-text">{{ current_user.username[0]|upper }}</span>
                        </div>
                        <h4 class="mb-1 text-primary">{{ current_user.full_name or current_user.username }}</h4>
                        <div class="mb-2">
                            <span class="badge bg-{{ 'danger' if current_user.role == 'admin' else 'primary' }}">
                                {{ 'Администратор' if current_user.role == 'admin' else 'Менеджер' }}
                            </span>
                        </div>
                        <p class="mb-0 text-muted">@{{ current_user.username }}</p>
                    </div>
                    
                    <hr>
                    
                    <div class="text-start profile-info">
                        <div class="mb-2">
                            <i class="fas fa-envelope me-2 text-muted"></i>
                            <strong>Email:</strong>
                            <span class="float-end profile-value">{{ current_user.email or 'Не указан' }}</span>
                        </div>
                        <div class="mb-2">
                            <i class="fas fa-phone me-2 text-muted"></i>
                            <strong>Телефон:</strong>
                            <span class="float-end profile-value">{{ current_user.phone or 'Не указан' }}</span>
                        </div>
                        <div class="mb-2">
                            <i class="fas fa-calendar-alt me-2 text-muted"></i>
                            <strong>Дата регистрации:</strong>
                            <span class="float-end profile-value">{{ current_user.created_at.strftime('%d.%m.%Y') }}</span>
                        </div>
                        {% if current_user.last_login %}
                        <div class="mb-2">
                            <i class="fas fa-sign-in-alt me-2 text-muted"></i>
                            <strong>Последний вход:</strong>
                            <span class="float-end profile-value">{{ current_user.last_login.strftime('%d.%m.%Y %H:%M') }}</span>
                        </div>
                        {% endif %}
                        <div>
                            <i class="fas fa-user-check me-2 text-muted"></i>
                            <strong>Статус:</strong>
                            <span class="float-end badge bg-{{ 'success' if current_user.is_active else 'danger' }}">
                                {{ 'Активен' if current_user.is_active else 'Неактивен' }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Статистика -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Моя активность</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="stat-number">{{ created_devices_count }}</div>
                            <div class="stat-label text-muted">Устройств</div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="stat-number">{{ created_tasks_count }}</div>
                            <div class="stat-label text-muted">Задач</div>
                        </div>
                        <div class="col-6">
                            <div class="stat-number">{{ log_count }}</div>
                            <div class="stat-label text-muted">Действий</div>
                        </div>
                        <div class="col-6">
                            <div class="stat-number">{{ user_days }}</div>
                            <div class="stat-label text-muted">Дней в системе</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-8 col-md-7">
            <!-- Форма редактирования профиля -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-edit me-2"></i>Редактировать профиль</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('update_profile') }}">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="full_name" class="form-label">Полное имя</label>
                                <input type="text" class="form-control" id="full_name" name="full_name" 
                                       value="{{ current_user.full_name or '' }}">
                            </div>
                            <div class="col-md-6">
                                <label for="username" class="form-label">Имя пользователя</label>
							<input type="text" class="form-control readonly-input" id="username" name="username" 
								   value="{{ current_user.username }}" readonly>
                                <small class="text">Имя пользователя нельзя изменить</small>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" name="email" 
                                       value="{{ current_user.email or '' }}">
                            </div>
                            <div class="col-md-6">
                                <label for="phone" class="form-label">Телефон</label>
                                <input type="tel" class="form-control" id="phone" name="phone" 
                                       value="{{ current_user.phone or '' }}">
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <h6 class="mb-3"><i class="fas fa-key me-2"></i>Изменение пароля</h6>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="current_password" class="form-label">Текущий пароль</label>
                                <input type="password" class="form-control" id="current_password" 
                                       name="current_password" placeholder="Введите текущий пароль">
                            </div>
                            <div class="col-md-4">
                                <label for="new_password" class="form-label">Новый пароль</label>
                                <input type="password" class="form-control" id="new_password" 
                                       name="new_password" placeholder="Введите новый пароль">
                            </div>
                            <div class="col-md-4">
                                <label for="confirm_password" class="form-label">Подтверждение</label>
                                <input type="password" class="form-control" id="confirm_password" 
                                       name="confirm_password" placeholder="Повторите новый пароль">
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Оставьте поля пароля пустыми, если не хотите менять пароль
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Сохранить изменения
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Недавние действия -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Мои последние действия</h5>
                </div>
                <div class="card-body p-0">
                    {% if user_logs %}
                    <div class="list-group list-group-flush">
                        {% for log in user_logs[:2] %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <div>
                                    <h6 class="mb-1" style="font-size: 0.9rem;">
                                        {{ log.action|replace('_', ' ')|title }}
                                    </h6>
                                    {% if log.device %}
                                    <p class="mb-0" style="font-size: 0.8rem;">
                                        <i class="fas fa-server me-1 text-muted"></i>
                                        {{ log.device.name }}
                                    </p>
                                    {% endif %}
                                </div>
                                <small class="text-muted">{{ log.timestamp.strftime('%H:%M') }}</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-history fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Нет действий за последнее время</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    .avatar-circle {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: linear-gradient(45deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 36px;
        font-weight: bold;
        margin: 0 auto;
    }
    
    .avatar-text {
        text-transform: uppercase;
    }
    
    .stat-number {
        font-size: 28px;
        font-weight: bold;
        color: var(--primary-color);
    }
    
    .stat-label {
        font-size: 14px;
        margin-top: 5px;
    }
    
    /* Стили для информации в профиле */
    .profile-info strong {
        color: var(--text-primary);
        font-weight: 600;
    }
    
    .profile-value {
        color: var(--text-primary);
    }
    
    .text-primary {
        color: var(--primary-color) !important;
    }
    
    /* Стиль для полей только для чтения */
    .readonly-input {
        background-color: var(--bg-tertiary) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
        opacity: 0.8;
        cursor: not-allowed;
    }
    
    .readonly-input:focus {
        box-shadow: none;
        border-color: var(--border-color) !important;
    }
    
    /* Темная тема для полей ввода */
    [data-theme="dark"] .form-control {
        background-color: var(--input-bg);
        border-color: var(--input-border);
        color: var(--input-text);
    }
    
    /* Адаптация аватара для темной темы */
    [data-theme="dark"] .avatar-circle {
        background: linear-gradient(45deg, #4a5568, #2d3748);
    }
    
    /* Адаптация карточек для темной темы */
    [data-theme="dark"] .card {
        background-color: var(--bg-secondary);
        border-color: var(--border-color);
    }
    
    [data-theme="dark"] .card-header {
        background-color: var(--bg-tertiary);
        border-bottom-color: var(--border-color);
    }
    
    /* Стили для alert в темной теме */
    [data-theme="dark"] .alert-info {
        background-color: var(--bg-tertiary);
        border-color: var(--border-color);
        color: var(--text-primary);
    }
</style>
{% endblock %}
