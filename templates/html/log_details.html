<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h5>Детали записи лога #{{ log.id }}</h5>
            <hr>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">Основная информация</h6>
                </div>
                <div class="card-body">
                    <table class="table table-sm table-borderless">
                        <tr>
                            <th style="width: 40%">ID записи:</th>
                            <td>{{ log.id }}</td>
                        </tr>
                        <tr>
                            <th>Время события:</th>
                            <td>{{ log.timestamp.strftime('%d.%m.%Y %H:%M:%S') }}</td>
                        </tr>
                        <tr>
                            <th>Действие:</th>
                            <td>
                                <span class="badge bg-{{ 
                                    'success' if 'added' in log.action 
                                    else 'info' if 'check' in log.action 
                                    else 'warning' if 'update' in log.action 
                                    else 'primary' if 'task' in log.action 
                                    else 'secondary' 
                                }}">
                                    {{ log.action|replace('_', ' ')|title }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <th>Пользователь:</th>
                            <td>
                                {% if log.performed_by_user %}
                                {{ log.performed_by_user.username }}
                                {% else %}
                                <span class="text-muted">Система</span>
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Информация об устройстве</h6>
                </div>
                <div class="card-body">
                    {% if log.device %}
                    <table class="table table-sm table-borderless">
                        <tr>
                            <th style="width: 40%">Устройство:</th>
                            <td>{{ log.device.name }}</td>
                        </tr>
                        <tr>
                            <th>IP адрес:</th>
                            <td>{{ log.device.ip_address }}:{{ log.device.port }}</td>
                        </tr>
                        <tr>
                            <th>Статус:</th>
                            <td>
                                <span class="badge bg-{{ 'success' if log.device.status == 'online' else 'danger' }}">
                                    {{ log.device.status }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <th>Версия ПО:</th>
                            <td>{{ log.device.firmware_version or 'Неизвестно' }}</td>
                        </tr>
                    </table>
                    {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Устройство было удалено или не найдено
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="mb-0">Результат выполнения</h6>
                </div>
                <div class="card-body">
                    {% if log.result %}
                        {# Проверяем, является ли результат JSON #}
                        {% if log.result.startswith('{') or log.result.startswith('[') %}
                            <div class="mb-3">
                                <h6>Данные результата:</h6>
                                <pre class="mb-0 bg-light p-3 rounded"><code>{{ log.result }}</code></pre>
                            </div>
                            
                            {# Пытаемся определить статус #}
                            {% if 'success' in log.result|lower %}
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>Статус:</strong> Успешно
                            </div>
                            {% elif 'error' in log.result|lower %}
                            <div class="alert alert-danger">
                                <i class="fas fa-times-circle me-2"></i>
                                <strong>Статус:</strong> Ошибка
                            </div>
                            {% endif %}
                            
                            {# Пытаемся извлечь сообщение #}
                            {% if 'message' in log.result|lower %}
                                {% set lines = log.result.split('\n') %}
                                {% for line in lines %}
                                    {% if 'message' in line|lower and ':' in line %}
                                        {% set message_parts = line.split(':') %}
                                        {% if message_parts|length > 1 %}
                                        <div class="mb-3">
                                            <h6>Сообщение:</h6>
                                            <div class="alert alert-info">
                                                {{ message_parts[1:]|join(':')|trim }}
                                            </div>
                                        </div>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                            
                        {% else %}
                            {# Простой текст #}
                            <pre class="mb-0 bg-light p-3 rounded"><code>{{ log.result }}</code></pre>
                        {% endif %}
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-info-circle fa-3x mb-3"></i>
                            <p>Нет данных о результате</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-3">
        <div class="col-12">
            <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Закрыть
                </button>
            </div>
        </div>
    </div>
</div>