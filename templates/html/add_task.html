{% extends "base.html" %}

{% block title %}Добавить задачу - MikroTik Manager{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">Создание новой задачи</h4>
            </div>
            <div class="card-body">
                <form method="POST" id="taskForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="name" class="form-label">Название задачи *</label>
                            <input type="text" class="form-control" id="name" name="name" required 
                                   placeholder="Например: Ежедневная проверка обновлений">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="task_type" class="form-label">Тип задачи *</label>
                            <select class="form-select" id="task_type" name="task_type" required>
                                <option value="">Выберите тип задачи</option>
                                <option value="check_update">Проверка обновлений</option>
                                <option value="perform_update">Выполнение обновлений</option>
                                <option value="custom_command">Пользовательская команда</option>
                                <option value="backup_config">Резервное копирование конфигурации</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="commandBlock" style="display: none;">
                        <label for="command" class="form-label">Команда MikroTik *</label>
                        <input type="text" class="form-control" id="command" name="command" 
                               placeholder="/system resource print">
                        <div class="form-text">Введите команду для выполнения на устройствах</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Выберите устройства *</label>
                        <div class="card">
                            <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                                <div class="mb-2">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" 
                                            onclick="selectAllDevices()">Выбрать все</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" 
                                            onclick="deselectAllDevices()">Снять все</button>
                                </div>
                                {% for device in devices %}
                                <div class="form-check">
                                    <input class="form-check-input device-checkbox" type="checkbox" 
                                           name="device_ids" value="{{ device.id }}" id="device_{{ device.id }}">
                                    <label class="form-check-label" for="device_{{ device.id }}">
                                        {{ device.name }} ({{ device.ip_address }})
                                        <small class="text-muted">- {{ device.description or 'Без описания' }}</small>
                                    </label>
                                </div>
                                {% endfor %}
                                {% if not devices %}
                                <div class="text-center text-muted py-3">
                                    <i class="fas fa-exclamation-circle me-1"></i>
                                    Нет доступных устройств. Сначала добавьте устройства.
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="cron_expression" class="form-label">Расписание (Cron) *</label>
                            <input type="text" class="form-control" id="cron_expression" name="cron_expression" 
                                   required placeholder="0 2 * * *"
                                   pattern="^(\S+\s+){4}\S+$">
                            <div class="form-text">Формат: минута час день месяц день_недели</div>
                            <div class="mt-2">
                                <small class="text-muted">Примеры:</small>
                                <ul class="list-unstyled small">
                                    <li><code>0 2 * * *</code> - Каждый день в 2:00</li>
                                    <li><code>0 */6 * * *</code> - Каждые 6 часов</li>
                                    <li><code>0 9 * * 1</code> - Каждый понедельник в 9:00</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Предустановки расписания</label>
                            <div class="btn-group-vertical w-100" role="group">
                                <button type="button" class="btn btn-outline-secondary text-start" 
                                        onclick="setCron('0 2 * * *')">
                                    <i class="fas fa-sun me-1"></i>Ежедневно в 2:00
                                </button>
                                <button type="button" class="btn btn-outline-secondary text-start" 
                                        onclick="setCron('0 9 * * 1')">
                                    <i class="fas fa-calendar-day me-1"></i>Каждый понедельник в 9:00
                                </button>
                                <button type="button" class="btn btn-outline-secondary text-start" 
                                        onclick="setCron('0 */6 * * *')">
                                    <i class="fas fa-clock me-1"></i>Каждые 6 часов
                                </button>
                                <button type="button" class="btn btn-outline-secondary text-start" 
                                        onclick="setCron('0 0 1 * *')">
                                    <i class="fas fa-calendar-alt me-1"></i>1-го числа каждого месяца
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="is_active" name="is_active" checked>
                            <label class="form-check-label" for="is_active">
                                Активировать задачу сразу после создания
                            </label>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('tasks') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Отмена
                        </a>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="fas fa-plus-circle me-1"></i>Создать задачу
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Помощник по Cron -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Помощник по расписанию Cron</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Минуты (0-59)</label>
                            <input type="text" class="form-control" id="cron_minute" placeholder="0" 
                                   onchange="updateCronPreview()">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Часы (0-23)</label>
                            <input type="text" class="form-control" id="cron_hour" placeholder="2" 
                                   onchange="updateCronPreview()">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">День месяца (1-31)</label>
                            <input type="text" class="form-control" id="cron_day" placeholder="*" 
                                   onchange="updateCronPreview()">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Месяц (1-12)</label>
							<small class="form-text d-block">1 = Январь, 12 = Декабрь</small>
                            <input type="text" class="form-control" id="cron_month" placeholder="*" 
                                   onchange="updateCronPreview()">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">День недели (0-6)</label>
                            <small class="form-text d-block">0 = воскресенье, 1 = понедельник</small>
                            <input type="text" class="form-control" id="cron_weekday" placeholder="*" 
                                   onchange="updateCronPreview()">
                        </div>
                    </div>
                </div>
                <div class="alert alert-info">
                    <strong>Предпросмотр:</strong> 
                    <code id="cronPreview">0 2 * * *</code>
                    <br>
                    <span id="cronDescription">Каждый день в 2:00</span>
                </div>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="applyCronFromHelper()">
                    Применить это расписание
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Показать/скрыть поле команды в зависимости от типа задачи
document.getElementById('task_type').addEventListener('change', function() {
    const commandBlock = document.getElementById('commandBlock');
    if (this.value === 'custom_command') {
        commandBlock.style.display = 'block';
        document.getElementById('command').required = true;
    } else {
        commandBlock.style.display = 'none';
        document.getElementById('command').required = false;
    }
});

// Выбор всех устройств
function selectAllDevices() {
    document.querySelectorAll('.device-checkbox').forEach(cb => cb.checked = true);
}

// Снятие выбора всех устройств
function deselectAllDevices() {
    document.querySelectorAll('.device-checkbox').forEach(cb => cb.checked = false);
}

// Установка Cron выражения
function setCron(expression) {
    document.getElementById('cron_expression').value = expression;
    updateCronDescription(expression);
}

// Обновление предпросмотра Cron
function updateCronPreview() {
    const minute = document.getElementById('cron_minute').value || '*';
    const hour = document.getElementById('cron_hour').value || '*';
    const day = document.getElementById('cron_day').value || '*';
    const month = document.getElementById('cron_month').value || '*';
    const weekday = document.getElementById('cron_weekday').value || '*';
    
    const cron = `${minute} ${hour} ${day} ${month} ${weekday}`;
    document.getElementById('cronPreview').textContent = cron;
    updateCronDescription(cron);
}

// Применение Cron из помощника
function applyCronFromHelper() {
    const cron = document.getElementById('cronPreview').textContent;
    document.getElementById('cron_expression').value = cron;
}

// Функция для описания Cron (упрощенная)
function updateCronDescription(cron) {
    const parts = cron.split(' ');
    const descriptions = [];
    
    if (parts[0] !== '*') descriptions.push(`в ${parts[0]} минуту`);
    if (parts[1] !== '*') descriptions.push(`в ${parts[1]} час`);
    if (parts[2] !== '*') descriptions.push(`${parts[2]} числа`);
    if (parts[3] !== '*') descriptions.push(`в ${parts[3]} месяце`);
    if (parts[4] !== '*') descriptions.push(`в день недели: ${parts[4]}`);
    
    const description = descriptions.length > 0 
        ? 'Выполняется ' + descriptions.join(', ') 
        : 'Выполняется постоянно';
    
    document.getElementById('cronDescription').textContent = description;
}

// Валидация формы
document.getElementById('taskForm').addEventListener('submit', function(e) {
    const selectedDevices = document.querySelectorAll('.device-checkbox:checked');
    if (selectedDevices.length === 0) {
        e.preventDefault();
        alert('Выберите хотя бы одно устройство');
        return false;
    }
    
    const cronExpression = document.getElementById('cron_expression').value;
    const cronPattern = /^(\S+\s+){4}\S+$/;
    if (!cronPattern.test(cronExpression)) {
        e.preventDefault();
        alert('Введите корректное выражение Cron');
        return false;
    }
    
    // Блокируем кнопку отправки
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Создание...';
});

// Инициализация
document.addEventListener('DOMContentLoaded', function() {
    updateCronPreview();
});
</script>
{% endblock %}